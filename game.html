<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>game</title>
	<style>
		canvas {
			border: 1px black solid;
		}
	</style>
</head>
<body>
	<canvas id="id-canvas" width="300" height="500"></canvas>
	<hr>
	<input id="id-input-fps" type="range" value="1">
	<script src="utils.js"></script>
	<script src="birdGame.js"></script>
	<script src="bird.js"></script>
	<script src="ball.js"></script>
	<script src="block.js"></script>
	<script src="level.js"></script>
	<script>

var blocks = [];
var enableDebugMode = function(enable) {
	if (!enable) {
		return;
	}

	window.addEventListener('keydown', function(event) {
		var k = event.key;

		if ('123456789'.includes(k)) {
			log(loadLevel(k))
			blocks = loadLevel(k);
		}
	});

	document.querySelector('#id-input-fps').addEventListener('input', function(event) {
		// log(event.target)
		log('fps = ' + window.fps);
		window.fps = event.target.value;
	});
};

var __main = function() {
	enableDebugMode(true);
	
	var game = BirdGame();
	var bird = Bird();
	var ball = Ball();
	var score = 0;
	
	blocks = loadLevel(1);

	game.registerActions('a', function() {
		bird.moveLeft();
	});

	game.registerActions('d', function() {
		bird.moveRight();
	});

	game.registerActions('f', function() {
		ball.fire();
	});

	game.registerActions('p', function() {
		ball.pause();
	});

	game.update = function() {
		// 挡板与球
		if (bird.collide(ball)) {
			ball.bounce();
		}
		ball.move();

		// 球与砖块
		for (var i = 0; i < blocks.length; i++) {
			// 砖块存在时再判断相撞
			if (blocks[i].alive && ball.collide(blocks[i])) {
				blocks[i].kill();
				ball.bounce();
				score += 100;
			}	
		}
		
	}

	game.draw = function() {
		game.drawImage(ball);
		game.drawImage(bird);

		for (var i = 0; i <  blocks.length; i++) {
			if (blocks[i].alive) {
				game.drawImage(blocks[i]);		
			}	
		}

		game.context.font = '18px serif';
	 	game.context.fillText('Score：' + score, 10, 485);
		
	};
}

__main();
		
	</script>
</body>
</html>